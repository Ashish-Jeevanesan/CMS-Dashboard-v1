<div class="user-dashboard-container">
    <h2>User Management</h2>
    <div class="action-buttons">
      <button (click)="loadUsers()" class="refresh-btn" [class.rotating]="loading">
        <i class="fas fa-sync-alt"></i>
        Refresh Users
      </button>
    </div>
  </div>
  
  <div *ngIf="loading" class="loading-container">
    <div class="loader"></div>
    <span>Loading users...</span>
  </div>
  
  <div *ngIf="successMessage" class="success-message">
    {{ successMessage }}
  </div>
  
  <div *ngIf="errorMessage" class="error-message">
    <i class="fas fa-exclamation-circle"></i>
    {{ errorMessage }}
    <button (click)="loadUsers()" class="retry-btn">
      <i class="fas fa-redo"></i> Retry
    </button>
  </div>
  
  <div *ngIf="!loading && !errorMessage">
    <table class="user-table" *ngIf="users.length > 0">
      <thead>
        <tr>
          <th>ID</th>
          <th>User Name</th>
          <th>First Name</th>
          <th>Last Name</th>
          <th>Email</th>
          <th>Role</th>
          <th>Mapped Church</th>
          <th>Access Permissions</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let user of users" [class.updating]="updatingUserId === user.userId">
          <td>{{ user.userId }}</td>
          <td>{{ user.userName }}</td>
          <td>{{ user.userFName }}</td>
          <td>{{ user.userLName || 'N/A' }}</td>
          <td>{{ user.userEmail }}</td>
          <td>{{ user.role?.roleName || 'N/A' }}</td>
          <td>{{ user.church?.churchName || 'N/A' }}</td>
          <td>
            <ng-container *ngIf="editAccessUserId === user.userId; else viewAccessMap">
              <table class="access-map-table">
                <thead>
                  <tr>
                    <th>Module</th>
                    <th>Read</th>
                    <th>Write</th>
                    <th>Delete</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let module of ['sermons', 'announcements', 'events']" >
                    <td>{{ module }}</td>
                    <td><input type="checkbox" [(ngModel)]="editableAccessMap![module].read"></td>
                    <td><input type="checkbox" [(ngModel)]="editableAccessMap![module].write"></td>
                    <td><input type="checkbox" [(ngModel)]="editableAccessMap![module].delete"></td>
                  </tr>
                </tbody>
              </table>
            </ng-container>
            <ng-template #viewAccessMap>
              <table class="access-map-table">
                <thead>
                  <tr>
                    <th>Module</th>
                    <th>R</th>
                    <th>W</th>
                    <th>D</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let module of ['sermons', 'announcements', 'events']">
                    <td>{{ module }}</td>
                    <td><span [class.enabled]="user.accessMap![module].read">✔</span></td>
                    <td><span [class.enabled]="user.accessMap![module].write">✔</span></td>
                    <td><span [class.enabled]="user.accessMap![module].delete">✔</span></td>
                  </tr>
                </tbody>
              </table>
            </ng-template>
          </td>
          <td>
            <ng-container *ngIf="editAccessUserId === user.userId; else editButton">
              <button class="save-btn" (click)="saveAccessMap(user)">Save</button>
              <button class="cancel-btn" (click)="cancelEditAccess()">Cancel</button>
            </ng-container>
            <ng-template #editButton>
              <button class="edit-btn" (click)="startEditAccess(user)" *ngIf="isAdmin">Edit</button>
            </ng-template>
          </td>
        </tr>
      </tbody>
    </table>
    
    <div *ngIf="users.length === 0 && !loading" class="no-data">
      No users found.
    </div>
  </div>

  <app-access-dialog
    *ngIf="showAccessDialog"
    [isOpen]="showAccessDialog"
    [accessMap]="selectedUserAccess!"
    (close)="closeAccessDialog()"
    (save)="saveAccessChanges($event)">
  </app-access-dialog>